{% extends 'base.html' %}

{% block title %}–ì–æ–ª–æ–≤–Ω–∞ - Online Newspaper{% endblock %}

{% block content %}

{% if news_list %}
{% for news in news_list %}
{% if news.is_breaking and forloop.first %}
<div class="bg-danger text-white py-2 mb-3 text-center fw-bold shadow-sm">
    <div class="container d-flex justify-content-center align-items-center">
        <span class="me-2 fs-4">üî•</span>
        <span class="text-uppercase me-3">Breaking News:</span>
        <a href="{% url 'publication_detail' news.pk %}" class="text-white text-decoration-underline">
            {{ news.title }}
        </a>
    </div>
</div>
{% endif %}
{% endfor %}
{% endif %}

<div class="container py-4">

    <div class="p-5 mb-4 bg-white rounded-3 shadow-sm">
        <div class="container-fluid py-2">
            <h1 class="display-5 fw-bold">{{ page_title|default:"–°–≤—ñ–∂—ñ –Ω–æ–≤–∏–Ω–∏" }}</h1>
            <p class="col-md-8 fs-4">–ê–∫—Ç—É–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è, –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ç–∞ —Ç–µ—Ä–º—ñ–Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.</p>

            {% if not user.is_authenticated %}
            <p>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤.</p>
            <a class="btn btn-primary btn-lg" href="{% url 'login' %}" role="button">–£–≤—ñ–π—Ç–∏</a>
            <a class="btn btn-outline-secondary btn-lg ms-2" href="{% url 'register' %}" role="button">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
            {% else %}
            <p class="fs-5">–í—ñ—Ç–∞—î–º–æ, <strong>{{ user.username }}</strong>!</p>

            {% if user.subscription %}
            <span class="badge bg-success fs-6">
                        –í–∞—à –ø–ª–∞–Ω: {{ user.subscription.plan.name|default:"–ù–µ–≤—ñ–¥–æ–º–∏–π" }}
                    </span>
            {% if user.subscription.is_active %}
            <span class="badge bg-info text-dark">–ê–∫—Ç–∏–≤–Ω–∞</span>
            {% else %}
            <a href="{% url 'pricing' %}" class="text-decoration-none" title="–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –ø–æ–Ω–æ–≤–∏—Ç–∏">
                <span class="badge bg-danger">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞ (–ü–æ–Ω–æ–≤–∏—Ç–∏)</span>
            </a>
            {% endif %}
            {% else %}
            <span class="badge bg-secondary">–ë–µ–∑ –ø—ñ–¥–ø–∏—Å–∫–∏</span>
            <a href="/admin/subscriptions/usersubscription/add/"
               class="btn btn-sm btn-outline-primary ms-2">–û—Ñ–æ—Ä–º–∏—Ç–∏</a>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="row align-items-md-stretch" id="news-container">
        {% if recommended_news %}
        <div class="alert alert-light border shadow-sm mb-4">
            <h5 class="text-primary"><i class="fas fa-magic me-2"></i>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è –í–∞—Å</h5>
            <div class="row">
                {% for rec in recommended_news %}
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-light">
                        <div class="card-body p-2">
                            <h6 class="card-title">
                                <a href="{% url 'publication_detail' rec.pk %}" class="text-decoration-none text-dark">
                                    {{ rec.title|truncatechars:40 }}
                                </a>
                            </h6>
                            <small class="text-muted">
                                <i class="fas fa-tag me-1"></i>{{ rec.category.name|default:"General" }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% for pub in news_list %}
            {% if forloop.counter == 3 %}
            {% if not user.is_authenticated or not user.subscription.is_active or user.subscription.plan.strategy_type == 'student' %}
            <div class="col-12 mb-4">
                <div class="ad-banner" style="height: 150px; background-color: #fff3cd; border-color: #ffecb5;">
                    <span style="background: #ffeeba;">–ü–∞—Ä—Ç–Ω–µ—Ä—Å—å–∫–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª</span>
                    <a href="{% url 'pricing' %}" class="btn btn-sm btn-outline-warning mt-2">–ü—Ä–∏–±—Ä–∞—Ç–∏ —Ä–µ–∫–ª–∞–º—É</a>
                </div>
            </div>
            {% endif %}
        {% endif %}
        <div class="col-md-6 mb-4 news-item">
            <div class="h-100 p-4 bg-white border rounded-3 shadow-sm d-flex flex-column">
                <div class="mb-2">
                    {% if pub.is_breaking %}
                    <span class="badge bg-danger">BREAKING NEWS</span>
                    {% endif %}
                    {% if pub.is_exclusive %}
                    <span class="badge bg-warning text-dark">‚≠ê Exclusive</span>
                    {% endif %}
                    <span class="badge bg-light text-dark border">{{ pub.category.name }}</span>
                </div>

                <h2>
                    <a href="{% url 'publication_detail' pub.pk %}" class="text-decoration-none text-dark">
                        {{ pub.title }}
                    </a>
                </h2>

                <p class="text-muted small">
                    –ê–≤—Ç–æ—Ä: {{ pub.author.username }} | {{ pub.created_at|date:"d.m.Y H:i" }}
                </p>

                <p class="flex-grow-1">
                    {{ pub.content|truncatewords:20 }}
                </p>

                <div class="mt-auto d-flex gap-2">
                    <a href="{% url 'publication_detail' pub.pk %}" class="btn btn-outline-primary flex-grow-1">
                        {% if pub.is_exclusive %}–ß–∏—Ç–∞—Ç–∏ (Premium){% else %}–ß–∏—Ç–∞—Ç–∏ –ø–æ–≤–Ω—ñ—Å—Ç—é{% endif %}
                    </a>

                    {% if user.is_authenticated %}
                    {% if pub in user.bookmarks.all %}
                    <a href="{% url 'toggle_bookmark' pub.pk %}" class="btn btn-warning" title="–ü—Ä–∏–±—Ä–∞—Ç–∏ –∑ –∑–∞–∫–ª–∞–¥–æ–∫">
                        <i class="fas fa-bookmark"></i>
                    </a>
                    {% else %}
                    <a href="{% url 'toggle_bookmark' pub.pk %}" class="btn btn-outline-secondary" title="–í –∑–∞–∫–ª–∞–¥–∫–∏">
                        <i class="far fa-bookmark"></i>
                    </a>
                    {% endif %}
                    {% endif %}

                    {% if user.is_authenticated and user == pub.author and user.is_editor or user.is_superuser %}
                    <a href="{% url 'edit_publication' pub.pk %}" class="btn btn-warning">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                –ù–æ–≤–∏–Ω –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î
            </div>
        </div>
        {% endfor %}
    </div>

    {% if page_obj.has_next %}
    <div class="text-center mt-4 mb-5">
        <button id="load-more-btn" class="btn btn-primary rounded-pill px-4 shadow-sm"
                data-next-page="{{ page_obj.next_page_number }}">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—ñ–ª—å—à–µ –Ω–æ–≤–∏–Ω
        </button>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const loadBtn = document.getElementById('load-more-btn');
        const container = document.getElementById('news-container');

        if (loadBtn) {
            loadBtn.addEventListener('click', function () {
                const nextPage = this.getAttribute('data-next-page');
                const url = `?page=${nextPage}`;

                const originalText = this.innerText;
                this.innerText = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
                this.disabled = true;

                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');

                        const newItems = doc.querySelectorAll('.news-item');

                        newItems.forEach(item => container.appendChild(item));

                        const newBtn = doc.getElementById('load-more-btn');
                        if (newBtn) {
                            loadBtn.setAttribute('data-next-page', newBtn.getAttribute('data-next-page'));
                            loadBtn.innerText = originalText;
                            loadBtn.disabled = false;
                        } else {
                            loadBtn.remove();
                        }
                    })
                    .catch(err => {
                        console.error('Error loading news:', err);
                        loadBtn.innerText = "–ü–æ–º–∏–ª–∫–∞";
                    });
            });
        }
    });
</script>
{% endblock %}